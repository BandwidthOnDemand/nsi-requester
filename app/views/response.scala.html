@(request: Option[String], response: Option[String])(implicit httpRequest: Request[AnyContent], flash: Flash)

@import helper._

@main("NSI Responses", "response") {
    <section>
        <h1>NSI Responses <span>(# of Async <span id="numberOfResponses">0</span>)</span></h1>
        <div class="content">
            @response.map(response => xmlBlock("The Response", response))
            @request.map(request => xmlBlock("The Request", request))
        </div>
        <div id="template" class="template">
            @xmlBlock("Callback Response", "")
        </div>
    </section>

    <script src="http://js.pusher.com/1.12/pusher.min.js" type="text/javascript"></script>
    <script>
       var appendTime = function(xmlBlock) {
         var now = new Date();
         var minutes = now.getMinutes() < 10 ? "0" + now.getMinutes() : now.getMinutes();
         var seconds = now.getSeconds() < 10 ? "0" + now.getSeconds() : now.getSeconds();
         var nowString = now.getHours() + ':' + minutes + ':' + seconds;
         xmlBlock.find("h3").append($("<span/>", {"class": "time", text: nowString}));
       }

       var nsiResponse = function(xml) {
         xmlBlock = $("#template > div").clone();
         xmlBlock.find(".prettyprint").text(xml);
         appendTime(xmlBlock);
         xmlBlock.prependTo("section .content");
         prettyPrint();
       }

       var increaseResponses = function() {
         var number = $("#numberOfResponses");
         number.text(parseInt(number.text()) + 1);
       }

       var pusher = new Pusher('9b313b09b03b1631fc81');
       var channel = pusher.subscribe('response_channel');

       channel.bind('response', function(data) {
         nsiResponse(data);
         increaseResponses();
       })

       $(function() {
         appendTime($(".content > .xml-content"))
       })
    </script>
}

@xmlBlock(title: String, content: String) = {
    <div class="xml-content">
        <div class="message"><h3>@title</h3></div>
        <pre class="prettyprint">@content</pre>
    </div>
}
